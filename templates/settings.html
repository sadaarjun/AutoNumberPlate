{% extends "base_simple.html" %}

{% block content %}
<h1 class="mb-4">System Settings</h1>

<div class="row">
    <!-- Society Settings Section -->
    <div class="col-md-12 mb-4">
        <div class="card">
            <div class="card-header">
                <h5>Society Details</h5>
            </div>
            <div class="card-body">
                <form action="/settings" method="post">
                    <div class="mb-3">
                        <label for="society_name" class="form-label">Society Name</label>
                        <input type="text" class="form-control" id="society_name" name="society_name"
                               value="{{ society.name }}" required>
                    </div>
                    <button type="submit" name="save_society" class="btn btn-primary">Save Society Details</button>
                </form>
            </div>
        </div>
    </div>

    <!-- ANPR Settings Section -->
    <div class="col-md-12 mb-4">
        <div class="card">
            <div class="card-header">
                <h5>ANPR Settings</h5>
            </div>
            <div class="card-body">
                <form action="/settings" method="post">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="min_plate_size" class="form-label">Minimum Plate Size (pixels²)</label>
                            <input type="number" class="form-control" id="min_plate_size" name="min_plate_size"
                                   value="{{ anpr_settings.min_plate_size }}" min="100" max="10000" required>
                            <div class="form-text">Minimum area of license plate in the image</div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="max_plate_size" class="form-label">Maximum Plate Size (pixels²)</label>
                            <input type="number" class="form-control" id="max_plate_size" name="max_plate_size"
                                   value="{{ anpr_settings.max_plate_size }}" min="1000" max="100000" required>
                            <div class="form-text">Maximum area of license plate in the image</div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="min_confidence" class="form-label">Minimum Confidence (%)</label>
                            <input type="number" class="form-control" id="min_confidence" name="min_confidence"
                                   value="{{ anpr_settings.min_confidence }}" min="0" max="100" required>
                            <div class="form-text">Minimum confidence level for plate detection</div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <div class="form-check form-switch mt-4">
                                <input class="form-check-input" type="checkbox" id="enable_preprocessing"
                                       name="enable_preprocessing" {% if anpr_settings.enable_preprocessing %}checked{% endif %}>
                                <label class="form-check-label" for="enable_preprocessing">Enable Image Preprocessing</label>
                            </div>
                            <div class="form-text">Apply image enhancement before detection</div>
                        </div>
                    </div>
                    <button type="submit" name="save_anpr" class="btn btn-primary">Save ANPR Settings</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Camera Settings Section -->
    <div class="col-md-12 mb-4">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5>Camera Settings</h5>
                <button class="btn btn-success btn-sm" id="addCameraBtn">
                    <i class="bi bi-plus-circle"></i> Add Camera
                </button>
            </div>
            <div class="card-body">
                <div class="accordion" id="cameraAccordion">
                    {% for camera in camera_settings %}
                    <div class="accordion-item mb-3" id="camera-item-{{ camera.id }}">
                        <h2 class="accordion-header" id="heading{{ camera.id }}">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                                    data-bs-target="#collapse{{ camera.id }}" aria-expanded="false"
                                    aria-controls="collapse{{ camera.id }}">
                                {{ camera.name }}
                                {% if camera.enabled %}
                                <span class="badge bg-success ms-2">Enabled</span>
                                {% else %}
                                <span class="badge bg-danger ms-2">Disabled</span>
                                {% endif %}
                            </button>
                        </h2>
                        <div id="collapse{{ camera.id }}" class="accordion-collapse collapse"
                             aria-labelledby="heading{{ camera.id }}" data-bs-parent="#cameraAccordion">
                            <div class="accordion-body">
                                <form action="/settings" method="post">
                                    <input type="hidden" name="camera_id" value="{{ camera.id }}">
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label for="camera_name_{{ camera.id }}" class="form-label">Camera Name</label>
                                            <input type="text" class="form-control" id="camera_name_{{ camera.id }}"
                                                   name="camera_name" value="{{ camera.name }}" required>
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label for="camera_url_{{ camera.id }}" class="form-label">Camera URL/ID</label>
                                            <input type="text" class="form-control" id="camera_url_{{ camera.id }}"
                                                   name="camera_url" value="{{ camera.url }}" required>
                                            <div class="form-text">RTSP URL, HTTP image URL, or device ID (0, 1, etc.)</div>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label for="camera_username_{{ camera.id }}" class="form-label">Username</label>
                                            <input type="text" class="form-control" id="camera_username_{{ camera.id }}"
                                                   name="camera_username" value="{{ camera.username }}">
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label for="camera_password_{{ camera.id }}" class="form-label">Password</label>
                                            <input type="password" class="form-control" id="camera_password_{{ camera.id }}"
                                                   name="camera_password" value="{{ camera.password }}">
                                        </div>
                                    </div>
                                    <div class="mb-3">
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox" id="camera_enabled_{{ camera.id }}"
                                                   name="camera_enabled" {% if camera.enabled %}checked{% endif %}>
                                            <label class="form-check-label" for="camera_enabled_{{ camera.id }}">Enable Camera</label>
                                        </div>
                                    </div>
                                    <div class="d-flex">
                                        <button type="submit" name="save_camera" class="btn btn-primary me-2">Update Camera</button>
                                        <button type="button" class="btn btn-danger delete-camera-btn"
                                                data-camera-id="{{ camera.id }}">Delete Camera</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>

                <!-- New Camera Form (initially hidden) -->
                <div id="newCameraForm" class="mt-4 border rounded p-3" style="display: none;">
                    <h5 class="mb-3">Add New Camera</h5>
                    <form action="/settings" method="post">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="camera_name" class="form-label">Camera Name</label>
                                <input type="text" class="form-control" id="camera_name" name="camera_name" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="camera_url" class="form-label">Camera URL/ID</label>
                                <input type="text" class="form-control" id="camera_url" name="camera_url" required>
                                <div class="form-text">RTSP URL, HTTP image URL, or device ID (0, 1, etc.)</div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="camera_username" class="form-label">Username</label>
                                <input type="text" class="form-control" id="camera_username" name="camera_username">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="camera_password" class="form-label">Password</label>
                                <input type="password" class="form-control" id="camera_password" name="camera_password">
                            </div>
                        </div>
                        <div class="mb-3">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="camera_enabled" name="camera_enabled" checked>
                                <label class="form-check-label" for="camera_enabled">Enable Camera</label>
                            </div>
                        </div>
                        <div class="d-flex">
                            <button type="submit" name="save_camera" class="btn btn-success me-2">Add Camera</button>
                            <button type="button" id="cancelAddCamera" class="btn btn-secondary">Cancel</button>
                        </div>
                    </form>
                </div>

                <!-- No Cameras Message -->
                {% if not camera_settings %}
                <div id="noCamerasMessage" class="alert alert-info">
                    No cameras configured. Click "Add Camera" to add a new camera.
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block additional_scripts %}
<script src="{{ url_for('static', filename='js/settings.js') }}"></script>
{% endblock %}
