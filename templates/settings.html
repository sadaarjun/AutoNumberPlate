{% extends "base.html" %}

{% block title %}Settings - ANPR System{% endblock %}

{% block content %}
<div class="col-12">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1><i class="bi bi-gear me-2"></i>System Settings</h1>
        <div>
            <button type="submit" form="settingsForm" class="btn btn-primary">
                <i class="bi bi-save me-1"></i> Save Changes
            </button>
        </div>
    </div>

    <div class="card">
        <div class="card-header bg-secondary text-white d-flex justify-content-between align-items-center">
            <h5 class="mb-0">Configuration</h5>
            <span class="badge bg-info">Admin Only</span>
        </div>
        <div class="card-body">
            <form id="settingsForm" method="POST" action="{{ url_with_token('dashboard.settings') }}">
                <!-- Multi-Camera Settings -->
                <div class="settings-section">
                    <h4 class="settings-header"><i class="bi bi-camera-video me-2"></i>Multi-Camera Settings</h4>
                    <div class="row">
                        <div class="col-md-4">
                            <div class="mb-3 form-check form-switch mt-2">
                                <input type="checkbox" class="form-check-input" id="multi_camera_enabled" name="multi_camera_enabled"
                                       {% if config and config.is_multi_camera_enabled() %}checked{% endif %}>
                                <label class="form-check-label" for="multi_camera_enabled">Enable Multi-Camera Support</label>
                            </div>
                        </div>
                    </div>

                    <div id="cameraListSection" class="mt-3 {% if not config or not config.is_multi_camera_enabled() %}d-none{% endif %}">
                        <h5><i class="bi bi-list-check me-2"></i>Camera List</h5>

                        <div class="table-responsive">
                            <table class="table table-striped table-bordered">
                                <thead class="table-dark">
                                <tr>
                                    <th>ID</th>
                                    <th>Name</th>
                                    <th>Enabled</th>
                                    <th>Active</th>
                                    <th>Actions</th>
                                </tr>
                                </thead>
                                <tbody id="cameraListBody">
                                {% if config and config.get_camera_list() %}
                                {% for camera in config.get_camera_list() %}
                                <tr>
                                    <td>{{ camera.id }}</td>
                                    <td>{{ camera.name }}</td>
                                    <td>
                                        <div class="form-check form-switch">
                                            <input type="checkbox" class="form-check-input camera-enabled"
                                                   data-camera-id="{{ camera.id }}"
                                                   name="camera_enabled_{{ camera.id }}"
                                                   {% if camera.enabled %}checked{% endif %}>
                                        </div>
                                    </td>
                                    <td>
                                        <div class="form-check">
                                            <input type="radio" class="form-check-input camera-active"
                                                   data-camera-id="{{ camera.id }}"
                                                   name="active_camera" value="{{ camera.id }}"
                                                   {% if config.get_active_camera_id() == camera.id %}checked{% endif %}>
                                        </div>
                                    </td>
                                    <td>
                                        <button type="button" class="btn btn-sm btn-outline-primary edit-camera"
                                                data-camera-id="{{ camera.id }}" data-camera-name="{{ camera.name }}">
                                            <i class="bi bi-pencil"></i> Edit
                                        </button>
                                        {% if camera.id != 'main' %}
                                        <button type="button" class="btn btn-sm btn-outline-danger delete-camera"
                                                data-camera-id="{{ camera.id }}">
                                            <i class="bi bi-trash"></i> Delete
                                        </button>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                                {% endif %}
                                </tbody>
                            </table>
                        </div>

                        <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                            <button type="button" class="btn btn-primary" id="addCameraBtn">
                                <i class="bi bi-plus-circle me-2"></i>Add Camera
                            </button>
                        </div>

                        <!-- Camera Edit Modal -->
                        <div class="modal fade" id="cameraEditModal" tabindex="-1" aria-hidden="true">
                            <div class="modal-dialog">
                                <div class="modal-content">
                                    <div class="modal-header">
                                        <h5 class="modal-title" id="cameraModalTitle">Edit Camera</h5>
                                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                    </div>
                                    <div class="modal-body">
                                        <input type="hidden" id="camera_id" name="camera_id">
                                        <div class="mb-3">
                                            <label for="camera_name" class="form-label">Camera Name</label>
                                            <input type="text" class="form-control" id="camera_name" name="camera_name" required>
                                        </div>
                                    </div>
                                    <div class="modal-footer">
                                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                        <button type="button" class="btn btn-primary" id="saveCameraBtn">Save</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Camera Settings -->
                <div class="settings-section">
                    <h4 class="settings-header"><i class="bi bi-camera me-2"></i>Camera Settings</h4>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="camera_resolution_width" class="form-label">Resolution Width (px)</label>
                                <input type="number" class="form-control" id="camera_resolution_width" name="camera_resolution_width"
                                       value="{{ config.get_camera_resolution()[0] if config else 1920 }}">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="camera_resolution_height" class="form-label">Resolution Height (px)</label>
                                <input type="number" class="form-control" id="camera_resolution_height" name="camera_resolution_height"
                                       value="{{ config.get_camera_resolution()[1] if config else 1080 }}">
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="camera_framerate" class="form-label">Framerate</label>
                                <input type="number" class="form-control" id="camera_framerate" name="camera_framerate"
                                       value="{{ config.get_camera_framerate() if config else 30 }}">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="camera_rotation" class="form-label">Rotation (degrees)</label>
                                <select class="form-select" id="camera_rotation" name="camera_rotation">
                                    <option value="0" {% if not config or config.get_camera_rotation() == 0 %}selected{% endif %}>0</option>
                                    <option value="90" {% if config and config.get_camera_rotation() == 90 %}selected{% endif %}>90</option>
                                    <option value="180" {% if config and config.get_camera_rotation() == 180 %}selected{% endif %}>180</option>
                                    <option value="270" {% if config and config.get_camera_rotation() == 270 %}selected{% endif %}>270</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="max_image_width" class="form-label">Max Image Width (px)</label>
                                <input type="number" class="form-control" id="max_image_width" name="max_image_width"
                                       value="{{ config.get_max_image_width() if config else 1280 }}">
                                <div class="form-text">Set to 0 for no resizing</div>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3 form-check form-switch">
                                <input type="checkbox" class="form-check-input" id="continuous_capture" name="continuous_capture"
                                       {% if not config or config.get_continuous_capture() %}checked{% endif %}>
                                <label class="form-check-label" for="continuous_capture">Enable Continuous Capture</label>
                                <div class="form-text">Keep camera continuously capturing in background</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3 form-check form-switch">
                                <input type="checkbox" class="form-check-input" id="enhance_contrast" name="enhance_contrast"
                                       {% if not config or config.get_enhance_contrast() %}checked{% endif %}>
                                <label class="form-check-label" for="enhance_contrast">Enhance Image Contrast</label>
                                <div class="form-text">Apply contrast enhancement to improve plate recognition</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ANPR Settings -->
                <div class="settings-section">
                    <h4 class="settings-header"><i class="bi bi-card-text me-2"></i>ANPR Settings</h4>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="processing_interval" class="form-label">Processing Interval (seconds)</label>
                                <input type="number" step="0.1" class="form-control" id="processing_interval" name="processing_interval"
                                       value="{{ config.get_processing_interval() if config else 2 }}">
                                <div class="form-text">Time between ANPR processing attempts</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="confidence_threshold" class="form-label">Confidence Threshold</label>
                                <input type="number" step="0.01" min="0" max="1" class="form-control" id="confidence_threshold" name="confidence_threshold"
                                       value="{{ config.get_confidence_threshold() if config else 0.7 }}">
                                <div class="form-text">Minimum confidence level (0-1) for plate recognition</div>
                            </div>
                        </div>
                    </div>
                    <div class="mb-3 form-check form-switch">
                        <input type="checkbox" class="form-check-input" id="auto_register_vehicles" name="auto_register_vehicles"
                               {% if not config or config.get_auto_register_vehicles() %}checked{% endif %}>
                        <label class="form-check-label" for="auto_register_vehicles">Auto-Register New Vehicles</label>
                        <div class="form-text">Automatically add new vehicles to the database when detected</div>
                    </div>
                </div>

                <!-- MyGate API Settings -->
                <div class="settings-section">
                    <h4 class="settings-header"><i class="bi bi-building me-2"></i>MyGate API Settings</h4>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="community_id" class="form-label">Community ID</label>
                                <input type="text" class="form-control" id="community_id" name="community_id"
                                       value="{{ config.get_community_id() if config else '' }}">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="device_id" class="form-label">Device ID</label>
                                <input type="text" class="form-control" id="device_id" name="device_id"
                                       value="{{ config.get_device_id() if config else '' }}">
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="entry_point_name" class="form-label">Entry Point Name</label>
                        <input type="text" class="form-control" id="entry_point_name" name="entry_point_name"
                               value="{{ config.get_entry_point_name() if config else 'Main Gate' }}">
                    </div>
                    <div class="alert alert-info">
                        <h5><i class="bi bi-info-circle me-2"></i>API Key Management</h5>
                        <p>API keys are managed through environment variables for security reasons and cannot be changed here.</p>
                        <ul class="mb-0">
                            <li><strong>PLATE_RECOGNIZER_API_KEY:</strong> {{ env_vars.PLATE_RECOGNIZER_API_KEY if env_vars.PLATE_RECOGNIZER_API_KEY else 'Not set' }}</li>
                            <li><strong>MYGATE_API_KEY:</strong> {{ env_vars.MYGATE_API_KEY if env_vars.MYGATE_API_KEY else 'Not set' }}</li>
                            <li><strong>MYGATE_API_URL:</strong> {{ env_vars.MYGATE_API_URL if env_vars.MYGATE_API_URL else 'Default URL' }}</li>
                        </ul>
                    </div>
                </div>

                <!-- System Settings -->
                <div class="settings-section">
                    <h4 class="settings-header"><i class="bi bi-cpu me-2"></i>System Settings</h4>
                    <div class="row">
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="society_name" class="form-label">Society Name</label>
                                <input type="text" class="form-control" id="society_name" name="society_name"
                                       value="{{ config.get_society_name() if config else 'ANPR System' }}">
                                <div class="form-text">Name of the society/community shown in header</div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="log_level" class="form-label">Log Level</label>
                                <select class="form-select" id="log_level" name="log_level">
                                    <option value="DEBUG" {% if config and config.get_log_level() == 'DEBUG' %}selected{% endif %}>DEBUG</option>
                                    <option value="INFO" {% if not config or config.get_log_level() == 'INFO' %}selected{% endif %}>INFO</option>
                                    <option value="WARNING" {% if config and config.get_log_level() == 'WARNING' %}selected{% endif %}>WARNING</option>
                                    <option value="ERROR" {% if config and config.get_log_level() == 'ERROR' %}selected{% endif %}>ERROR</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="image_retention_days" class="form-label">Image Retention (days)</label>
                                <input type="number" class="form-control" id="image_retention_days" name="image_retention_days"
                                       value="{{ config.get_image_retention_days() if config else 30 }}">
                                <div class="form-text">Set to 0 to keep images indefinitely</div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3 form-check form-switch mt-4">
                                <input type="checkbox" class="form-check-input" id="debug_mode" name="debug_mode"
                                       {% if not config or config.get_debug_mode() %}checked{% endif %}>
                                <label class="form-check-label" for="debug_mode">Debug Mode</label>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="d-grid gap-2 mt-4">
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-save me-2"></i>Save All Settings
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Admin Password Card -->
    <div class="card mt-4">
        <div class="card-header bg-warning text-dark">
            <h5 class="mb-0"><i class="bi bi-shield-lock me-2"></i>Admin Password</h5>
        </div>
        <div class="card-body">
            <form id="adminPasswordForm" action="/dashboard/change_admin_password" method="POST">
                <div class="row">
                    <div class="col-md-4">
                        <div class="mb-3">
                            <label for="current_password" class="form-label">Current Password</label>
                            <input type="password" class="form-control" id="current_password" name="current_password" required>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="mb-3">
                            <label for="new_password" class="form-label">New Password</label>
                            <input type="password" class="form-control" id="new_password" name="new_password" required>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="mb-3">
                            <label for="confirm_password" class="form-label">Confirm New Password</label>
                            <input type="password" class="form-control" id="confirm_password" name="confirm_password" required>
                        </div>
                    </div>
                </div>
                <div class="d-grid gap-2">
                    <button type="submit" class="btn btn-warning">
                        <i class="bi bi-key me-2"></i>Change Admin Password
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- System Maintenance Card -->
    <div class="card mt-4">
        <div class="card-header bg-danger text-white">
            <h5 class="mb-0"><i class="bi bi-tools me-2"></i>System Maintenance</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-4">
                    <div class="card h-100">
                        <div class="card-body text-center">
                            <h5 class="card-title"><i class="bi bi-arrow-clockwise me-2"></i>Restart ANPR Service</h5>
                            <p class="card-text">Restart the ANPR detection service without rebooting the system.</p>
                            <button id="restartAnprBtn" class="btn btn-outline-primary">Restart Service</button>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card h-100">
                        <div class="card-body text-center">
                            <h5 class="card-title"><i class="bi bi-camera me-2"></i>Reinitialize Camera</h5>
                            <p class="card-text">Reset the camera if it's not responding or after changing settings.</p>
                            <button id="reinitCameraBtn" class="btn btn-outline-primary">Reset Camera</button>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card h-100">
                        <div class="card-body text-center">
                            <h5 class="card-title"><i class="bi bi-trash me-2"></i>Clean Old Images</h5>
                            <p class="card-text">Manually clean up old images to free up disk space.</p>
                            <button id="cleanImagesBtn" class="btn btn-outline-danger">Clean Images</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Helper function to get authentication token from URL
    function getAuthToken() {
        const urlParams = new URLSearchParams(window.location.search);
        return urlParams.get('token');
    }

    // Helper function to add token to API endpoint URLs
    function getApiUrl(endpoint) {
        const token = getAuthToken();
        if (token) {
            return `${endpoint}${endpoint.includes('?') ? '&' : '?'}token=${token}`;
        }
        return endpoint;
    }

    document.addEventListener('DOMContentLoaded', function() {
        // Multi-Camera Settings
        const multiCameraEnabled = document.getElementById('multi_camera_enabled');
        const cameraListSection = document.getElementById('cameraListSection');

        if (multiCameraEnabled && cameraListSection) {
            multiCameraEnabled.addEventListener('change', function() {
                if (this.checked) {
                    cameraListSection.classList.remove('d-none');
                } else {
                    cameraListSection.classList.add('d-none');
                }
            });
        }

        // Camera Edit Modal
        const cameraEditModal = new bootstrap.Modal(document.getElementById('cameraEditModal'), {});
        const cameraEditButtons = document.querySelectorAll('.edit-camera');
        const addCameraBtn = document.getElementById('addCameraBtn');
        const saveCameraBtn = document.getElementById('saveCameraBtn');

        // Edit camera button click
        cameraEditButtons.forEach(button => {
            button.addEventListener('click', function() {
                const cameraId = this.dataset.cameraId;
                const cameraName = this.dataset.cameraName;

                document.getElementById('cameraModalTitle').textContent = 'Edit Camera';
                document.getElementById('camera_id').value = cameraId;
                document.getElementById('camera_name').value = cameraName;

                cameraEditModal.show();
            });
        });

        // Add camera button click
        if (addCameraBtn) {
            addCameraBtn.addEventListener('click', function() {
                document.getElementById('cameraModalTitle').textContent = 'Add New Camera';
                document.getElementById('camera_id').value = '';
                document.getElementById('camera_name').value = '';

                cameraEditModal.show();
            });
        }

        // Save camera button click
        if (saveCameraBtn) {
            saveCameraBtn.addEventListener('click', function() {
                const cameraId = document.getElementById('camera_id').value;
                const cameraName = document.getElementById('camera_name').value;

                if (!cameraName) {
                    showAlert('Camera name is required', 'danger');
                    return;
                }

                // We'll handle this in the backend
                // For now, just submit the form
                const form = document.getElementById('settingsForm');

                // Add hidden fields for camera data
                let cameraIdInput = document.createElement('input');
                cameraIdInput.type = 'hidden';
                cameraIdInput.name = 'camera_action';
                cameraIdInput.value = cameraId ? 'edit' : 'add';
                form.appendChild(cameraIdInput);

                let cameraIdField = document.createElement('input');
                cameraIdField.type = 'hidden';
                cameraIdField.name = 'camera_action_id';
                cameraIdField.value = cameraId ? cameraId : '';
                form.appendChild(cameraIdField);

                let cameraNameField = document.createElement('input');
                cameraNameField.type = 'hidden';
                cameraNameField.name = 'camera_action_name';
                cameraNameField.value = cameraName;
                form.appendChild(cameraNameField);

                // Submit the form
                form.submit();

                // Close modal
                cameraEditModal.hide();
            });
        }

        // Delete camera buttons
        const deleteCameraButtons = document.querySelectorAll('.delete-camera');

        deleteCameraButtons.forEach(button => {
            button.addEventListener('click', function() {
                const cameraId = this.dataset.cameraId;

                if (confirm(`Are you sure you want to delete camera ${cameraId}?`)) {
                    // We'll handle this in the backend
                    // For now, just submit the form
                    const form = document.getElementById('settingsForm');

                    // Add hidden field for camera deletion
                    let deleteInput = document.createElement('input');
                    deleteInput.type = 'hidden';
                    deleteInput.name = 'camera_action';
                    deleteInput.value = 'delete';
                    form.appendChild(deleteInput);

                    let cameraIdField = document.createElement('input');
                    cameraIdField.type = 'hidden';
                    cameraIdField.name = 'camera_action_id';
                    cameraIdField.value = cameraId;
                    form.appendChild(cameraIdField);

                    // Submit the form
                    form.submit();
                }
            });
        });

        // Admin Password Form Validation
        const adminPasswordForm = document.getElementById('adminPasswordForm');
        if (adminPasswordForm) {
            adminPasswordForm.addEventListener('submit', function(event) {
                const newPassword = document.getElementById('new_password').value;
                const confirmPassword = document.getElementById('confirm_password').value;

                // Check if passwords match
                if (newPassword !== confirmPassword) {
                    event.preventDefault();
                    showAlert('New passwords do not match!', 'danger');
                    return false;
                }

                // Ensure password meets minimum requirements
                if (newPassword.length < 8) {
                    event.preventDefault();
                    showAlert('Password must be at least 8 characters long!', 'danger');
                    return false;
                }

                return true;
            });
        }

        // Restart ANPR Service
        const restartAnprBtn = document.getElementById('restartAnprBtn');
        if (restartAnprBtn) {
            restartAnprBtn.addEventListener('click', function() {
                if (confirm('Are you sure you want to restart the ANPR service?')) {
                    restartAnprBtn.disabled = true;
                    restartAnprBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Restarting...';

                    // First stop ANPR
                    fetch(getApiUrl('/api/anpr/stop'), {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        }
                    })
                    .then(response => response.json())
                    .then(data => {
                        // Wait a bit
                        setTimeout(() => {
                            // Then start ANPR
                            fetch(getApiUrl('/api/anpr/start'), {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                }
                            })
                            .then(response => response.json())
                            .then(data => {
                                if (data.success) {
                                    showAlert('ANPR service restarted successfully', 'success');
                                } else {
                                    showAlert('Failed to restart ANPR service: ' + data.message, 'danger');
                                }
                                restartAnprBtn.disabled = false;
                                restartAnprBtn.innerHTML = 'Restart Service';
                            })
                            .catch(error => {
                                showAlert('Error: ' + error, 'danger');
                                restartAnprBtn.disabled = false;
                                restartAnprBtn.innerHTML = 'Restart Service';
                            });
                        }, 2000);
                    })
                    .catch(error => {
                        showAlert('Error: ' + error, 'danger');
                        restartAnprBtn.disabled = false;
                        restartAnprBtn.innerHTML = 'Restart Service';
                    });
                }
            });
        }

        // Reinitialize Camera
        const reinitCameraBtn = document.getElementById('reinitCameraBtn');
        if (reinitCameraBtn) {
            reinitCameraBtn.addEventListener('click', function() {
                if (confirm('Are you sure you want to reinitialize the camera?')) {
                    reinitCameraBtn.disabled = true;
                    reinitCameraBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Reinitializing...';

                    // We need to implement this endpoint
                    // For now, just emulate the process with a timer
                    setTimeout(() => {
                        showAlert('Camera reinitialized successfully', 'success');
                        reinitCameraBtn.disabled = false;
                        reinitCameraBtn.innerHTML = 'Reset Camera';
                    }, 3000);
                }
            });
        }

        // Clean Old Images
        const cleanImagesBtn = document.getElementById('cleanImagesBtn');
        if (cleanImagesBtn) {
            cleanImagesBtn.addEventListener('click', function() {
                if (confirm('Are you sure you want to clean old images? This action cannot be undone.')) {
                    cleanImagesBtn.disabled = true;
                    cleanImagesBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Cleaning...';

                    // We need to implement this endpoint
                    // For now, just emulate the process with a timer
                    setTimeout(() => {
                        showAlert('Old images cleaned successfully', 'success');
                        cleanImagesBtn.disabled = false;
                        cleanImagesBtn.innerHTML = 'Clean Images';
                    }, 3000);
                }
            });
        }
    });
</script>
{% endblock %}
